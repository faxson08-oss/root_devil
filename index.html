<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inkwell Devil</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        body {
            background-color: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: 'Press Start 2P', cursive;
            color: white;
            overflow: hidden;
        }
        canvas {
            background-color: #e0e0e0;
            border: 5px solid #000;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #ui {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            font-size: 16px;
            color: #000;
            text-shadow: 1px 1px #fff, -1px -1px #fff, 1px -1px #fff, -1px 1px #fff;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div id="ui"></div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const uiDiv = document.getElementById('ui');

        // --- GAME SETUP ---
        const GRAVITY = 0.5;
        const FPS = 60;
        const FRAME_TIME = 1000 / FPS;

        let gameState = 'menu';
        let currentLevel = 0;
        let frameCount = 0;
        let particles = [];
        let screenShake = 0;

        // --- AUDIO CONTEXT ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playSound(frequency, duration, type = 'sine', volume = 0.3) {
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = type;
            
            gainNode.gain.setValueAtTime(volume, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + duration);
        }
        
        const sounds = {
            jump: () => { playSound(400, 0.1, 'square', 0.2); playSound(600, 0.1, 'square', 0.2); },
            die: () => { playSound(150, 0.3, 'sawtooth', 0.4); playSound(80, 0.5, 'sawtooth', 0.5); },
            win: () => { playSound(523, 0.1); playSound(659, 0.1); playSound(784, 0.2); },
            click: () => { playSound(800, 0.05, 'square', 0.1); },
            land: () => { playSound(200, 0.05, 'square', 0.1); }
        };
        
        // --- PARTICLE SYSTEM ---
        class Particle {
            constructor(x, y, vx, vy, color, life) {
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.color = color;
                this.life = life;
                this.maxLife = life;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.1;
                this.life--;
            }
            draw() {
                ctx.save();
                ctx.globalAlpha = this.life / this.maxLife;
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, 4, 4);
                ctx.restore();
            }
        }
        
        function createParticles(x, y, count, color) {
            for (let i = 0; i < count; i++) {
                particles.push(new Particle(x, y, (Math.random() - 0.5) * 6, (Math.random() - 0.5) * 6, color, 30));
            }
        }

        // --- PLAYER ---
        const player = {
            x: 100,
            y: 400,
            width: 24,
            height: 30,
            velocityX: 0,
            velocityY: 0,
            speed: 5,
            jumpPower: 12,
            isGrounded: false,
            facing: 1,
            state: 'idle',
            animationFrame: 0,
            animationTimer: 0,
            squashStretch: 1, // For squash and stretch effect
            
            draw() {
                ctx.save();
                // Apply squash and stretch
                ctx.translate(this.x + this.width / 2, this.y + this.height / 2);
                ctx.scale(1 / this.squashStretch, this.squashStretch);
                ctx.translate(-(this.x + this.width / 2), -(this.y + this.height / 2));

                // Flip sprite if facing left
                if (this.facing === -1) {
                    ctx.translate(this.x + this.width, this.y);
                    ctx.scale(-1, 1);
                    ctx.translate(-this.width, 0);
                } else {
                    ctx.translate(this.x, this.y);
                }

                // Body
                ctx.fillStyle = '#FFF';
                ctx.fillRect(4, 10, 16, 20);

                // Head
                ctx.fillRect(6, 0, 12, 12);

                // Legs animation
                if (this.state === 'running') {
                    const legOffset = Math.floor(this.animationFrame / 4) % 2;
                    ctx.fillRect(6, 28 - legOffset * 4, 4, 6);
                    ctx.fillRect(14, 28 - (1 - legOffset) * 4, 4, 6);
                } else if (this.state === 'jumping') {
                    ctx.fillRect(7, 28, 4, 4);
                    ctx.fillRect(13, 28, 4, 4);
                } else { // idle
                    ctx.fillRect(7, 28, 4, 6);
                    ctx.fillRect(13, 28, 4, 6);
                }
                
                // Eyes
                ctx.fillStyle = '#000';
                ctx.fillRect(8, 4, 2, 2);
                ctx.fillRect(14, 4, 2, 2);
                
                ctx.restore();
            },
            update() {
                this.animationTimer++;
                if (this.animationTimer > 4) {
                    this.animationTimer = 0;
                    this.animationFrame++;
                }
                
                // Update squash and stretch back to normal
                if (this.squashStretch < 1) this.squashStretch += 0.05;
                if (this.squashStretch > 1) this.squashStretch -= 0.05;

                // Controls
                const left = keys['ArrowLeft'] || keys['a'] || keys['A'];
                const right = keys['ArrowRight'] || keys['d'] || keys['D'];
                const jump = keys[' '] || keys['ArrowUp'] || keys['w'] || keys['W'];

                if (left) {
                    this.velocityX = -this.speed;
                    this.facing = -1;
                    if (this.isGrounded) this.state = 'running';
                } else if (right) {
                    this.velocityX = this.speed;
                    this.facing = 1;
                    if (this.isGrounded) this.state = 'running';
                } else {
                    this.velocityX *= 0.8;
                    if (this.isGrounded) this.state = 'idle';
                }

                if (jump && this.isGrounded) {
                    this.velocityY = -this.jumpPower;
                    this.isGrounded = false;
                    this.state = 'jumping';
                    sounds.jump();
                    createParticles(this.x + this.width/2, this.y + this.height, 5, '#999');
                }

                // Physics
                this.velocityY += GRAVITY;
                this.x += this.velocityX;
                this.y += this.velocityY;

                // Screen boundaries
                if (this.x < 0) this.x = 0;
                if (this.x + this.width > canvas.width) this.x = canvas.width - this.width;
                
                // Reset if fallen off the map
                if (this.y > canvas.height) {
                    triggerGameOver();
                }
            },
            reset() {
                this.x = levels[currentLevel].startPos.x;
                this.y = levels[currentLevel].startPos.y;
                this.velocityX = 0;
                this.velocityY = 0;
                this.isGrounded = false;
                this.state = 'idle';
                this.facing = 1;
                this.squashStretch = 1;
            }
        };

        // --- LEVEL DESIGN ---
        const levels = [
            { // Level 1
                name: "First Steps",
                startPos: { x: 50, y: 500 },
                objects: [
                    { type: 'platform', x: 0, y: 550, width: 250, height: 50 },
                    { type: 'platform', x: 350, y: 550, width: 450, height: 50 },
                    { type: 'spike', x: 250, y: 530, width: 100, height: 20 },
                    { type: 'goal', x: 720, y: 500, width: 40, height: 50 }
                ]
            },
            { // Level 2
                name: "A Small Leap",
                startPos: { x: 50, y: 500 },
                objects: [
                    { type: 'platform', x: 0, y: 550, width: 150, height: 50 },
                    { type: 'platform', x: 250, y: 480, width: 100, height: 20 },
                    { type: 'platform', x: 450, y: 550, width: 350, height: 50 },
                    { type: 'spike', x: 150, y: 530, width: 100, height: 20 },
                    { type: 'spike', x: 350, y: 530, width: 100, height: 20 },
                    { type: 'goal', x: 720, y: 500, width: 40, height: 50 }
                ]
            },
            { // Level 3
                name: "Trust Issues",
                startPos: { x: 50, y: 500 },
                objects: [
                    { type: 'platform', x: 0, y: 550, width: 200, height: 50 },
                    { type: 'spike', x: 200, y: 530, width: 150, height: 20, hidden: true },
                    { type: 'platform', x: 350, y: 550, width: 450, height: 50 },
                    { type: 'goal', x: 720, y: 500, width: 40, height: 50 }
                ]
            },
            { // Level 4
                name: "Up and Over",
                startPos: { x: 50, y: 500 },
                objects: [
                    { type: 'platform', x: 0, y: 550, width: 100, height: 50 },
                    { type: 'platform', x: 200, y: 450, width: 80, height: 20 },
                    { type: 'platform', x: 380, y: 350, width: 80, height: 20 },
                    { type: 'platform', x: 560, y: 250, width: 80, height: 20 },
                    { type: 'platform', x: 680, y: 550, width: 120, height: 50 },
                    { type: 'spike', x: 100, y: 530, width: 100, height: 20 },
                    { type: 'spike', x: 280, y: 530, width: 100, height: 20 },
                    { type: 'spike', x: 460, y: 530, width: 100, height: 20 },
                    { type: 'goal', x: 740, y: 500, width: 40, height: 50 }
                ]
            },
            { // Level 5
                name: "The Maze",
                startPos: { x: 20, y: 400 },
                objects: [
                    { type: 'platform', x: 0, y: 450, width: 150, height: 150 },
                    { type: 'platform', x: 150, y: 550, width: 20, height: 50 },
                    { type: 'platform', x: 170, y: 350, width: 150, height: 20 },
                    { type: 'platform', x: 170, y: 550, width: 150, height: 50 },
                    { type: 'platform', x: 320, y: 450, width: 20, height: 150 },
                    { type: 'platform', x: 340, y: 250, width: 150, height: 20 },
                    { type: 'platform', x: 340, y: 550, width: 200, height: 50 },
                    { type: 'platform', x: 540, y: 350, width: 20, height: 250 },
                    { type: 'platform', x: 560, y: 550, width: 240, height: 50 },
                    { type: 'spike', x: 320, y: 350, width: 20, height: 100 },
                    { type: 'goal', x: 720, y: 500, width: 40, height: 50 }
                ]
            },
            { // Level 6
                name: "Precise Jumps",
                startPos: { x: 50, y: 500 },
                objects: [
                    { type: 'platform', x: 0, y: 550, width: 100, height: 50 },
                    { type: 'platform', x: 150, y: 500, width: 40, height: 20 },
                    { type: 'platform', x: 250, y: 450, width: 40, height: 20 },
                    { type: 'platform', x: 350, y: 400, width: 40, height: 20 },
                    { type: 'platform', x: 450, y: 350, width: 40, height: 20 },
                    { type: 'platform', x: 550, y: 300, width: 40, height: 20 },
                    { type: 'platform', x: 650, y: 250, width: 150, height: 20 },
                    { type: 'goal', x: 730, y: 200, width: 40, height: 50 }
                ]
            },
            { // Level 7 - FIXED
                name: "Deceptive Ceiling",
                startPos: { x: 50, y: 500 },
                objects: [
                    { type: 'platform', x: 0, y: 550, width: 320, height: 50 }, // Made longer
                    { type: 'platform', x: 480, y: 550, width: 320, height: 50 }, // Made longer
                    { type: 'spike', x: 200, y: 100, width: 400, height: 20, direction: 'down' },
                    { type: 'spike', x: 320, y: 530, width: 160, height: 20 }, // Made shorter
                    { type: 'goal', x: 700, y: 500, width: 40, height: 50 }
                ]
            },
            { // Level 8
                name: "The Bait",
                startPos: { x: 50, y: 500 },
                objects: [
                    { type: 'platform', x: 0, y: 550, width: 200, height: 50 },
                    { type: 'platform', x: 250, y: 480, width: 40, height: 20 },
                    { type: 'platform', x: 250, y: 400, width: 100, height: 20 },
                    { type: 'spike', x: 350, y: 380, width: 100, height: 20, hidden: true },
                    { type: 'platform', x: 500, y: 300, width: 100, height: 20 },
                    { type: 'platform', x: 650, y: 550, width: 150, height: 50 },
                    { type: 'spike', x: 200, y: 530, width: 50, height: 20 },
                    { type: 'spike', x: 600, y: 530, width: 50, height: 20 },
                    { type: 'goal', x: 720, y: 500, width: 40, height: 50 }
                ]
            },
            { // Level 9
                name: "A Path of Thorns",
                startPos: { x: 50, y: 500 },
                objects: [
                    { type: 'platform', x: 0, y: 550, width: 50, height: 50 },
                    { type: 'spike', x: 50, y: 530, width: 20, height: 20 },
                    { type: 'platform', x: 70, y: 550, width: 20, height: 50 },
                    { type: 'spike', x: 90, y: 530, width: 20, height: 20 },
                    { type: 'platform', x: 110, y: 550, width: 20, height: 50 },
                    { type: 'spike', x: 130, y: 530, width: 20, height: 20 },
                    { type: 'platform', x: 150, y: 550, width: 20, height: 50 },
                    { type: 'spike', x: 170, y: 530, width: 20, height: 20 },
                    { type: 'platform', x: 190, y: 550, width: 20, height: 50 },
                    { type: 'spike', x: 210, y: 530, width: 20, height: 20 },
                    { type: 'platform', x: 230, y: 550, width: 20, height: 50 },
                    { type: 'spike', x: 250, y: 530, width: 20, height: 20 },
                    { type: 'platform', x: 270, y: 550, width: 20, height: 50 },
                    { type: 'spike', x: 290, y: 530, width: 20, height: 20 },
                    { type: 'platform', x: 310, y: 550, width: 20, height: 50 },
                    { type: 'spike', x: 330, y: 530, width: 20, height: 20 },
                    { type: 'platform', x: 350, y: 550, width: 20, height: 50 },
                    { type: 'spike', x: 370, y: 530, width: 20, height: 20 },
                    { type: 'platform', x: 390, y: 550, width: 20, height: 50 },
                    { type: 'spike', x: 410, y: 530, width: 20, height: 20 },
                    { type: 'platform', x: 430, y: 550, width: 20, height: 50 },
                    { type: 'spike', x: 450, y: 530, width: 20, height: 20 },
                    { type: 'platform', x: 470, y: 550, width: 20, height: 50 },
                    { type: 'spike', x: 490, y: 530, width: 20, height: 20 },
                    { type: 'platform', x: 510, y: 550, width: 20, height: 50 },
                    { type: 'spike', x: 530, y: 530, width: 20, height: 20 },
                    { type: 'platform', x: 550, y: 550, width: 250, height: 50 },
                    { type: 'goal', x: 720, y: 500, width: 40, height: 50 }
                ]
            },
            { // Level 10
                name: "False Summit",
                startPos: { x: 50, y: 500 },
                objects: [
                    { type: 'platform', x: 0, y: 550, width: 150, height: 50 },
                    { type: 'platform', x: 250, y: 450, width: 100, height: 20 },
                    { type: 'platform', x: 450, y: 350, width: 100, height: 20 },
                    { type: 'spike', x: 550, y: 330, width: 100, height: 20, hidden: true },
                    { type: 'platform', x: 650, y: 250, width: 150, height: 20 },
                    { type: 'spike', x: 150, y: 530, width: 100, height: 20 },
                    { type: 'spike', x: 350, y: 530, width: 100, height: 20 },
                    { type: 'goal', x: 730, y: 200, width: 40, height: 50 }
                ]
            },
            { // Level 11
                name: "Don't Look Down",
                startPos: { x: 400, y: 100 },
                objects: [
                    { type: 'platform', x: 0, y: 550, width: 800, height: 50 },
                    { type: 'platform', x: 100, y: 450, width: 80, height: 20 },
                    { type: 'platform', x: 300, y: 350, width: 80, height: 20 },
                    { type: 'platform', x: 500, y: 250, width: 80, height: 20 },
                    { type: 'platform', x: 700, y: 150, width: 80, height: 20 },
                    { type: 'spike', x: 0, y: 530, width: 100, height: 20 },
                    { type: 'spike', x: 180, y: 530, width: 120, height: 20 },
                    { type: 'spike', x: 380, y: 530, width: 120, height: 20 },
                    { type: 'spike', x: 580, y: 530, width: 120, height: 20 },
                    { type: 'goal', x: 740, y: 100, width: 40, height: 50 }
                ]
            },
            { // Level 12
                name: "The Switchback",
                startPos: { x: 50, y: 500 },
                objects: [
                    { type: 'platform', x: 0, y: 550, width: 100, height: 50 },
                    { type: 'platform', x: 150, y: 500, width: 500, height: 20 },
                    { type: 'spike', x: 100, y: 530, width: 50, height: 20 },
                    { type: 'spike', x: 650, y: 480, width: 100, height: 20, direction: 'down' },
                    { type: 'platform', x: 700, y: 550, width: 100, height: 50 },
                    { type: 'goal', x: 750, y: 500, width: 40, height: 50 }
                ]
            },
            { // Level 13
                name: "Double Jeopardy",
                startPos: { x: 50, y: 500 },
                objects: [
                    { type: 'platform', x: 0, y: 550, width: 200, height: 50 },
                    { type: 'spike', x: 200, y: 530, width: 20, height: 20, hidden: true },
                    { type: 'spike', x: 220, y: 530, width: 20, height: 20, hidden: true },
                    { type: 'spike', x: 240, y: 530, width: 20, height: 20, hidden: true },
                    { type: 'spike', x: 260, y: 530, width: 20, height: 20, hidden: true },
                    { type: 'spike', x: 280, y: 530, width: 20, height: 20, hidden: true },
                    { type: 'spike', x: 300, y: 530, width: 20, height: 20, hidden: true },
                    { type: 'spike', x: 320, y: 530, width: 20, height: 20, hidden: true },
                    { type: 'spike', x: 340, y: 530, width: 20, height: 20, hidden: true },
                    { type: 'spike', x: 360, y: 530, width: 20, height: 20, hidden: true },
                    { type: 'spike', x: 380, y: 530, width: 20, height: 20, hidden: true },
                    { type: 'spike', x: 400, y: 530, width: 20, height: 20, hidden: true },
                    { type: 'spike', x: 420, y: 530, width: 20, height: 20, hidden: true },
                    { type: 'spike', x: 440, y: 530, width: 20, height: 20, hidden: true },
                    { type: 'spike', x: 460, y: 530, width: 20, height: 20, hidden: true },
                    { type: 'spike', x: 480, y: 530, width: 20, height: 20, hidden: true },
                    { type: 'spike', x: 500, y: 530, width: 20, height: 20, hidden: true },
                    { type: 'spike', x: 520, y: 530, width: 20, height: 20, hidden: true },
                    { type: 'spike', x: 540, y: 530, width: 20, height: 20, hidden: true },
                    { type: 'spike', x: 560, y: 530, width: 20, height: 20, hidden: true },
                    { type: 'spike', x: 580, y: 530, width: 20, height: 20, hidden: true },
                    { type: 'platform', x: 600, y: 550, width: 200, height: 50 },
                    { type: 'goal', x: 720, y: 500, width: 40, height: 50 }
                ]
            },
            { // Level 14
                name: "Falling",
                startPos: { x: 50, y: 100 },
                objects: [
                    { type: 'platform', x: 0, y: 550, width: 800, height: 50 },
                    { type: 'platform', x: 100, y: 450, width: 80, height: 20, fall: true },
                    { type: 'platform', x: 250, y: 350, width: 80, height: 20, fall: true },
                    { type: 'platform', x: 400, y: 250, width: 80, height: 20, fall: true },
                    { type: 'platform', x: 550, y: 150, width: 80, height: 20, fall: true },
                    { type: 'goal', x: 720, y: 500, width: 40, height: 50 }
                ]
            },
            { // Level 15
                name: "The Gauntlet",
                startPos: { x: 50, y: 500 },
                objects: [
                    { type: 'platform', x: 0, y: 550, width: 100, height: 50 },
                    { type: 'spike', x: 100, y: 530, width: 20, height: 20 },
                    { type: 'spike', x: 120, y: 530, width: 20, height: 20 },
                    { type: 'spike', x: 140, y: 530, width: 20, height: 20 },
                    { type: 'spike', x: 160, y: 530, width: 20, height: 20 },
                    { type: 'spike', x: 180, y: 530, width: 20, height: 20 },
                    { type: 'platform', x: 200, y: 550, width: 40, height: 50 },
                    { type: 'spike', x: 240, y: 530, width: 20, height: 20 },
                    { type: 'spike', x: 260, y: 530, width: 20, height: 20 },
                    { type: 'spike', x: 280, y: 530, width: 20, height: 20 },
                    { type: 'spike', x: 300, y: 530, width: 20, height: 20 },
                    { type: 'spike', x: 320, y: 530, width: 20, height: 20 },
                    { type: 'platform', x: 340, y: 550, width: 40, height: 50 },
                    { type: 'spike', x: 380, y: 530, width: 20, height: 20 },
                    { type: 'spike', x: 400, y: 530, width: 20, height: 20 },
                    { type: 'spike', x: 420, y: 530, width: 20, height: 20 },
                    { type: 'spike', x: 440, y: 530, width: 20, height: 20 },
                    { type: 'spike', x: 460, y: 530, width: 20, height: 20 },
                    { type: 'platform', x: 480, y: 550, width: 40, height: 50 },
                    { type: 'spike', x: 520, y: 530, width: 20, height: 20 },
                    { type: 'spike', x: 540, y: 530, width: 20, height: 20 },
                    { type: 'spike', x: 560, y: 530, width: 20, height: 20 },
                    { type: 'spike', x: 580, y: 530, width: 20, height: 20 },
                    { type: 'spike', x: 600, y: 530, width: 20, height: 20 },
                    { type: 'platform', x: 620, y: 550, width: 180, height: 50 },
                    { type: 'goal', x: 720, y: 500, width: 40, height: 50 }
                ]
            },
            { // Level 16
                name: "Unseeing",
                startPos: { x: 50, y: 500 },
                objects: [
                    { type: 'platform', x: 0, y: 550, width: 100, height: 50 },
                    { type: 'platform', x: 200, y: 450, width: 80, height: 20 },
                    { type: 'platform', x: 380, y: 350, width: 80, height: 20 },
                    { type: 'platform', x: 560, y: 250, width: 80, height: 20 },
                    { type: 'platform', x: 700, y: 150, width: 100, height: 20 },
                    { type: 'spike', x: 100, y: 530, width: 100, height: 20 },
                    { type: 'spike', x: 280, y: 530, width: 100, height: 20 },
                    { type: 'spike', x: 460, y: 530, width: 100, height: 20 },
                    { type: 'spike', x: 640, y: 530, width: 60, height: 20 },
                    { type: 'goal', x: 750, y: 100, width: 40, height: 50 }
                ]
            },
            { // Level 17
                name: "One Way Trip",
                startPos: { x: 700, y: 500 },
                objects: [
                    { type: 'platform', x: 0, y: 550, width: 100, height: 50 },
                    { type: 'platform', x: 150, y: 450, width: 80, height: 20 },
                    { type: 'platform', x: 300, y: 350, width: 80, height: 20 },
                    { type: 'platform', x: 450, y: 250, width: 80, height: 20 },
                    { type: 'platform', x: 600, y: 150, width: 200, height: 20 },
                    { type: 'spike', x: 100, y: 530, width: 50, height: 20 },
                    { type: 'spike', x: 230, y: 530, width: 70, height: 20 },
                    { type: 'spike', x: 380, y: 530, width: 70, height: 20 },
                    { type: 'spike', x: 530, y: 530, width: 70, height: 20 },
                    { type: 'spike', x: 700, y: 130, width: 100, height: 20, direction: 'down' },
                    { type: 'goal', x: 50, y: 500, width: 40, height: 50 }
                ]
            },
            { // Level 18
                name: "The Real Fake",
                startPos: { x: 50, y: 500 },
                objects: [
                    { type: 'platform', x: 0, y: 550, width: 200, height: 50 },
                    { type: 'platform', x: 250, y: 480, width: 100, height: 20 },
                    { type: 'platform', x: 400, y: 380, width: 100, height: 20 },
                    { type: 'spike', x: 500, y: 360, width: 100, height: 20, hidden: true },
                    { type: 'platform', x: 600, y: 280, width: 100, height: 20 },
                    { type: 'spike', x: 700, y: 260, width: 100, height: 20, hidden: true },
                    { type: 'platform', x: 350, y: 180, width: 100, height: 20 },
                    { type: 'platform', x: 200, y: 80, width: 100, height: 20 },
                    { type: 'spike', x: 200, y: 530, width: 50, height: 20 },
                    { type: 'spike', x: 350, y: 530, width: 50, height: 20 },
                    { type: 'goal', x: 230, y: 30, width: 40, height: 50 }
                ]
            },
            { // Level 19
                name: "Just... Jump",
                startPos: { x: 50, y: 200 },
                objects: [
                    { type: 'platform', x: 0, y: 250, width: 100, height: 20 },
                    { type: 'platform', x: 700, y: 550, width: 100, height: 50 },
                    { type: 'spike', x: 0, y: 530, width: 700, height: 20 },
                    { type: 'goal', x: 750, y: 500, width: 40, height: 50 }
                ]
            },
            { // Level 20
                name: "Devil's Due",
                startPos: { x: 50, y: 500 },
                objects: [
                    { type: 'platform', x: 0, y: 550, width: 50, height: 50 },
                    { type: 'platform', x: 100, y: 500, width: 40, height: 20, fall: true },
                    { type: 'platform', x: 200, y: 450, width: 40, height: 20 },
                    { type: 'spike', x: 240, y: 430, width: 40, height: 20, hidden: true },
                    { type: 'platform', x: 320, y: 400, width: 40, height: 20, fall: true },
                    { type: 'platform', x: 420, y: 350, width: 40, height: 20 },
                    { type: 'spike', x: 460, y: 330, width: 40, height: 20, direction: 'down' },
                    { type: 'platform', x: 520, y: 300, width: 40, height: 20, fall: true },
                    { type: 'platform', x: 620, y: 250, width: 40, height: 20 },
                    { type: 'spike', x: 660, y: 230, width: 40, height: 20, hidden: true },
                    { type: 'platform', x: 720, y: 200, width: 80, height: 20 },
                    { type: 'spike', x: 50, y: 530, width: 50, height: 20 },
                    { type: 'spike', x: 140, y: 530, width: 60, height: 20 },
                    { type: 'spike', x: 360, y: 530, width: 60, height: 20 },
                    { type: 'spike', x: 560, y: 530, width: 60, height: 20 },
                    { type: 'spike', x: 700, y: 530, width: 20, height: 20 },
                    { type: 'goal', x: 760, y: 150, width: 40, height: 50 }
                ]
            }
        ];

        // --- INPUT HANDLING ---
        const keys = {};
        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            if (e.key === ' ' || e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') e.preventDefault();

            // Spacebar to retry
            if (gameState === 'gameOver' && e.key === ' ') {
                resetLevel();
                return;
            }
            if (gameState === 'levelComplete' && e.key === ' ') {
                nextLevel();
                return;
            }
        });
        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });
        canvas.addEventListener('click', () => {
            if (gameState === 'menu') {
                startGame();
            }
        });

        // --- GAME LOGIC ---
        function startGame() {
            sounds.click();
            gameState = 'playing';
            currentLevel = 0;
            player.reset();
        }

        function triggerGameOver() {
            if (gameState !== 'playing') return;
            sounds.die();
            createParticles(player.x + player.width/2, player.y + player.height/2, 20, '#000');
            screenShake = 15; // Trigger screen shake
            gameState = 'gameOver';
        }

        function triggerLevelComplete() {
            if (gameState !== 'playing') return;
            sounds.win();
            createParticles(player.x + player.width/2, player.y + player.height/2, 30, '#FFF');
            gameState = 'levelComplete';
        }

        function nextLevel() {
            sounds.click();
            currentLevel++;
            if (currentLevel >= levels.length) {
                currentLevel = 0;
            }
            player.reset();
            gameState = 'playing';
        }
        
        function resetLevel() {
            sounds.click();
            player.reset();
            gameState = 'playing';
            levels[currentLevel].objects.forEach(obj => {
                if (obj.fall) {
                    obj.fallen = false;
                    obj.y = obj.originalY;
                }
            });
        }

        function checkCollisions() {
            const wasGrounded = player.isGrounded;
            player.isGrounded = false;
            const level = levels[currentLevel];

            for (const obj of level.objects) {
                if (player.x < obj.x + obj.width &&
                    player.x + player.width > obj.x &&
                    player.y < obj.y + obj.height &&
                    player.y + player.height > obj.y) {

                    switch (obj.type) {
                        case 'platform':
                            const overlapX = Math.min(player.x + player.width - obj.x, obj.x + obj.width - player.x);
                            const overlapY = Math.min(player.y + player.height - obj.y, obj.y + obj.height - player.y);

                            if (overlapX < overlapY) {
                                if (player.x < obj.x) player.x = obj.x - player.width;
                                else player.x = obj.x + obj.width;
                                player.velocityX = 0;
                            } else {
                                if (player.y < obj.y) {
                                    player.y = obj.y - player.height;
                                    player.velocityY = 0;
                                    player.isGrounded = true;
                                    
                                    // Landing effect
                                    if (!wasGrounded && player.velocityY > 8) {
                                        sounds.land();
                                        createParticles(player.x + player.width/2, player.y + player.height, 3, '#555');
                                        player.squashStretch = 0.7;
                                        screenShake = 3;
                                    }

                                    if (obj.fall && !obj.fallen) {
                                        obj.fallen = true;
                                        obj.originalY = obj.y;
                                    }
                                } else {
                                    player.y = obj.y + obj.height;
                                    player.velocityY = 0;
                                }
                            }
                            break;
                        case 'spike':
                            triggerGameOver();
                            break;
                        case 'goal':
                            triggerLevelComplete();
                            break;
                    }
                }
            }
        }

        // --- DRAWING FUNCTIONS ---
        function drawBackground() {
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#f0f0f0');
            gradient.addColorStop(1, '#d0d0d0');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Parallax background trees
            ctx.fillStyle = '#cccccc';
            const treeOffset = (frameCount * 0.2) % (canvas.width + 100);
            for(let i = -1; i < 8; i++) {
                ctx.fillRect(i * 120 + treeOffset - 50, 200, 80, 350);
            }
            
            // Parallax clouds
            ctx.fillStyle = '#ffffff';
            const cloudOffset = (frameCount * 0.1) % (canvas.width + 100);
            drawCloud(cloudOffset - 100, 80);
            drawCloud(cloudOffset + 300, 120);
        }
        
        function drawCloud(x, y) {
            ctx.beginPath();
            ctx.arc(x, y, 25, 0, Math.PI * 2);
            ctx.arc(x + 25, y, 35, 0, Math.PI * 2);
            ctx.arc(x + 50, y, 25, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawLevel() {
            const level = levels[currentLevel];
            for (const obj of level.objects) {
                if (obj.fall && obj.fallen) {
                    obj.y += 8;
                }

                switch (obj.type) {
                    case 'platform':
                        ctx.fillStyle = '#000';
                        ctx.fillRect(obj.x, obj.y, obj.width, obj.height);
                        ctx.fillStyle = '#fff';
                        ctx.fillRect(obj.x, obj.y, obj.width, 2);
                        break;
                    case 'spike':
                        if (obj.hidden) {
                            ctx.fillStyle = '#000';
                            ctx.fillRect(obj.x, obj.y, obj.width, obj.height);
                            ctx.fillStyle = '#fff';
                            ctx.fillRect(obj.x, obj.y, obj.width, 2);
                        } else {
                            ctx.fillStyle = '#000';
                            const spikeDir = obj.direction === 'down' ? -1 : 1;
                            for (let i = 0; i < obj.width; i += 10) {
                                ctx.beginPath();
                                if (spikeDir > 0) {
                                    ctx.moveTo(obj.x + i, obj.y + obj.height);
                                    ctx.lineTo(obj.x + i + 5, obj.y);
                                    ctx.lineTo(obj.x + i + 10, obj.y + obj.height);
                                } else {
                                    ctx.moveTo(obj.x + i, obj.y);
                                    ctx.lineTo(obj.x + i + 5, obj.y + obj.height);
                                    ctx.lineTo(obj.x + i + 10, obj.y);
                                }
                                ctx.fill();
                            }
                        }
                        break;
                    case 'goal':
                        ctx.strokeStyle = '#000';
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        ctx.moveTo(obj.x + 15, obj.y);
                        ctx.lineTo(obj.x + 15, obj.y + obj.height);
                        ctx.stroke();
                        
                        ctx.fillStyle = '#000';
                        ctx.beginPath();
                        const wave = Math.sin((frameCount + obj.x) * 0.1) * 3;
                        ctx.moveTo(obj.x + 15, obj.y + 5);
                        ctx.quadraticCurveTo(obj.x + 30, obj.y + 10 + wave, obj.x + 15, obj.y + 15);
                        ctx.quadraticCurveTo(obj.x + 30, obj.y + 10 + wave, obj.x + 15, obj.y + 5);
                        ctx.fill();
                        break;
                }
            }
        }
        
        function drawMenu() {
            drawBackground();
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#FFF';
            ctx.textAlign = 'center';
            ctx.font = '48px "Press Start 2P"';
            ctx.fillText('INKWELL DEVIL', canvas.width / 2, canvas.height / 2 - 100);

            ctx.font = '16px "Press Start 2P"';
            ctx.fillText('A Monochrome Nightmare', canvas.width / 2, canvas.height / 2 - 40);

            ctx.font = '20px "Press Start 2P"';
            if (Math.floor(frameCount / 30) % 2 === 0) {
                ctx.fillText('CLICK TO START', canvas.width / 2, canvas.height / 2 + 40);
            }
            
            ctx.font = '14px "Press Start 2P"';
            ctx.fillText('Arrow Keys / WASD to Move, Space to Jump', canvas.width / 2, canvas.height / 2 + 100);
        }

        function drawGameOver() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#FFF';
            ctx.textAlign = 'center';
            ctx.font = '48px "Press Start 2P"';
            ctx.fillText('YOU DIED', canvas.width / 2, canvas.height / 2);

            ctx.font = '20px "Press Start 2P"';
            ctx.fillText('PRESS SPACE TO RETRY', canvas.width / 2, canvas.height / 2 + 50);
        }
        
        function drawLevelComplete() {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#000';
            ctx.textAlign = 'center';
            ctx.font = '48px "Press Start 2P"';
            ctx.fillText('LEVEL COMPLETE', canvas.width / 2, canvas.height / 2);

            ctx.font = '20px "Press Start 2P"';
            ctx.fillText('PRESS SPACE TO CONTINUE', canvas.width / 2, canvas.height / 2 + 50);
        }

        function drawUI() {
            if (gameState === 'playing') {
                uiDiv.innerHTML = `Level ${currentLevel + 1}: ${levels[currentLevel].name}`;
            } else {
                uiDiv.innerHTML = '';
            }
        }

        // --- MAIN GAME LOOP ---
        let lastTime = 0;
        function gameLoop(timestamp) {
            const deltaTime = timestamp - lastTime;
            if (deltaTime >= FRAME_TIME) {
                frameCount++;
                
                // Update
                if (gameState === 'playing') {
                    player.update();
                    checkCollisions();
                }

                // Update particles
                particles = particles.filter(p => p.life > 0);
                particles.forEach(p => p.update());
                
                // Update screen shake
                if (screenShake > 0) {
                    screenShake *= 0.9;
                    if (screenShake < 0.1) screenShake = 0;
                }

                // Draw
                ctx.save();
                if (screenShake > 0) {
                    const shakeX = (Math.random() - 0.5) * screenShake;
                    const shakeY = (Math.random() - 0.5) * screenShake;
                    ctx.translate(shakeX, shakeY);
                }

                drawBackground();
                if (gameState === 'playing') {
                    drawLevel();
                    player.draw();
                } else if (gameState === 'menu') {
                    drawMenu();
                } else if (gameState === 'gameOver') {
                    drawLevel();
                    player.draw();
                    drawGameOver();
                } else if (gameState === 'levelComplete') {
                    drawLevel();
                    player.draw();
                    drawLevelComplete();
                }
                
                particles.forEach(p => p.draw());
                
                ctx.restore(); // Restore context to remove screen shake translation
                
                drawUI();

                lastTime = timestamp;
            }
            requestAnimationFrame(gameLoop);
        }

        // Start the game loop
        requestAnimationFrame(gameLoop);
        
        // To enable sound on first user interaction
        document.body.addEventListener('click', () => {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }, { once: true });

    </script>
</body>
</html>
